{% extends 'base.html' %}

{% block titulo %}PEDIDO de Compra{% endblock %}

{% block contenido %}
<div class="container mt-4" style="max-width:1400px;">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">PEDIDO DE COMPRA</h4>
        </div>
        <div class="card-body">
            <!-- Encabezado pedido -->
            <div class="row mb-3">
                <div class="col-md-2">
                    <label>Nro Pedido</label>
                    <input type="text" id="txt_nro_pedido" class="form-control" readonly>
                </div>
                <div class="col-md-2">
                    <label>Tipo de Pedido</label>
                    <div>
                        <input type="radio" name="tipo_pedido" id="rb_sin_pedido" value="SIN" checked>
                        <label for="rb_sin_pedido">Sin Pedido</label>
                    </div>
                    <div>
                        <input type="radio" name="tipo_pedido" id="rb_con_pedido" value="CON">
                        <label for="rb_con_pedido">Con Pedido</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <label>Nro Solicitud</label>
                    <input type="text" id="txt_nro_solicitud" class="form-control" placeholder="Ingrese nro de solicitud" readonly>
                </div>
                <div class="col-md-2">
                    <label>Solicitante</label>
                    <select id="cbo_funcionario" class="form-control">
                        <option value="">Seleccione</option>
                        {% for f in funcionarios %}
                        <option value="{{ f['fun_id'] }}">{{ f['nombre_completo'] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label>Sucursal</label>
                    <select id="cbo_sucursal" class="form-control">
                        <option value="">Seleccione</option>
                        {% for s in sucursales %}
                        <option value="{{ s['id_sucursal'] }}">{{ s['descripcion'] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label>Depósito</label>
                    <select id="cbo_deposito" class="form-control">
                        <option value="">Seleccione</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label>Fecha Pedido</label>
                    <input type="date" id="txt_fecha_pedido" class="form-control">
                </div>
                <div class="col-md-2">
                    <label>Fecha Necesaria</label>
                    <input type="date" id="txt_fecha_necesaria" class="form-control">
                </div>
                <div class="col-md-2">
                    <label>Tipo de Factura</label>
                    <select id="cbo_tipo_factura" class="form-control">
                        <option value="">Seleccione</option>
                        <option value="CONTADO">Contado</option>
                        <option value="CREDITO">Crédito</option>
                    </select>
                </div>
            </div>

            <!-- Selección de proveedor y producto -->
            <div class="row mb-3 align-items-end">
                <div class="col-md-3">
                    <label>Proveedor</label>
                    <select id="cbo_proveedor_filtro" class="form-control">
                        <option value="">Seleccione</option>
                        {% for p in proveedores %}
                        <option value="{{ p['id_proveedor'] }}">{{ p['nombre'] }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label>Producto</label>
                    <select id="cbo_producto" class="form-control">
                        <option value="">Seleccione</option>
                        {% for i in productos %}
                        <option value="{{ i.id_producto }}"
                                data-proveedor-id="{{ i.id_proveedor }}"
                                data-proveedor-nombre="{{ i.proveedor_nombre }}"
                                data-codigo="{{ i.item_code }}"
                                data-precio="{{ i.precio_unitario }}">
                            {{ i.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label>Stock Actual</label>
                    <input type="number" id="txt_stock_actual" class="form-control" readonly>
                </div>
                <div class="col-md-1">
                    <label>Cantidad</label>
                    <input type="number" id="txt_cantidad" min="1" class="form-control">
                </div>
                <div class="col-md-2">
                    <label>Precio</label>
                    <input type="number" id="txt_precio_info" min="0" step="0.01" class="form-control">
                </div>
                <div class="col-md-1">
                    <button type="button" id="btn_agregar" class="btn btn-success">AGREGAR</button>
                </div>
            </div>

            <!-- Tabla detalle -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="table-responsive">
                        <table id="tbl_detalle" class="table table-bordered table-hover text-center table-striped align-middle">
                            <thead class="thead-light">
                                <tr>
                                    <th>Código</th>
                                    <th>Producto</th>
                                    <th>Proveedor</th>
                                    <th>Stock</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Subtotal</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="6" class="text-end">TOTAL</th>
                                    <th id="total">0.00</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Botones finales -->
            <div class="row mt-3">
                <div class="col d-flex justify-content-end">
                    <button type="button" id="btn_grabar_pedido" class="btn btn-primary mr-2">GRABAR</button>
                    <button type="button" class="btn btn-warning mr-2" id="btn_cancelar_general">CANCELAR</button>
                    <a href="{{ url_for('pdcmod.pedidos_index') }}" class="btn btn-danger">SALIR</a>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Input oculto para proveedor global -->
<input type="hidden" id="id_proveedor_global" value="">

{% endblock %}

{% block js %}
<script>
$(document).ready(function(){
    let detalle = [];
    let tabla = $('#tbl_detalle').DataTable({
        paging:true,
        info:true,
        searching:true,
        ordering:true,
        columnDefs:[
            { targets:-1, orderable:false },
            { targets:[3,4,5,6], className:'text-right' }
        ],
        columns:[
            {data:'codigo'},
            {data:'producto'},
            {data:'proveedor'},
            {data:'stock_actual'},
            {data:'cantidad'},
            {data:'precio'},
            {data:'subtotal'},
            {data:'acciones'}
        ]
    });

    function actualizarTotal(){
        let total = detalle.reduce((sum,d)=>sum+d.subtotal,0);
        $('#total').text(total.toFixed(2));
    }

    function cargarNroPedido(){
        $.getJSON('/api/v1/gestionar-compras/registrar-pedido-compras/siguiente-nro-pedido', function(res){
            $('#txt_nro_pedido').val(res.success ? res.siguiente_nro : 'Error');
        });
    }
    cargarNroPedido();

    function cargarDepositos(id_sucursal){
        $('#cbo_deposito').empty().append('<option value="">Seleccione</option>');
        if(id_sucursal){
            $.getJSON('/api/v1/sucursal-depositos/' + id_sucursal, function(res){
                if(res.success && res.data){
                    res.data.forEach(d=>$('#cbo_deposito').append(`<option value="${d.id_deposito}">${d.nombre_deposito}</option>`));
                }
            });
        }
    }
    $('#cbo_sucursal').change(function(){ cargarDepositos($(this).val()); });
    if($('#cbo_sucursal').val()){ cargarDepositos($('#cbo_sucursal').val()); }

    $('input[name="tipo_pedido"]').change(function(){
        if($('#rb_con_pedido').is(':checked')){
            $('#txt_nro_solicitud').prop('readonly', false).focus();
        } else {
            $('#txt_nro_solicitud').prop('readonly', true).val('');
            $('#cbo_funcionario,#cbo_sucursal,#cbo_deposito').prop('disabled', false);
        }
    });

    $('#txt_nro_solicitud').keypress(function(e){
        if(e.which===13){
            e.preventDefault();
            let nro = $(this).val();
            if(!nro) return Swal.fire('Error','Ingrese el nro de solicitud','error');

            $.getJSON(`/api/v1/gestionar-compras/registrar-pedido-compras/solicitud-nro/${nro}`, function(res){
                if(res.success && res.data){
                    $('#cbo_funcionario,#cbo_sucursal,#cbo_deposito').prop('disabled',true);
                    detalle = [];
                    tabla.clear().draw();

                    $('#cbo_funcionario').val(res.data.id_funcionario);
                    $('#cbo_sucursal').val(res.data.id_sucursal).trigger('change');
                    setTimeout(()=> { $('#cbo_deposito').val(res.data.id_deposito); }, 300);

                    let id_proveedor_global = res.data.detalle.length>0 ? res.data.detalle[0].id_proveedor : null;

                    res.data.detalle.forEach(d=>{
                        let cantidad = parseFloat(d.cant_pedido)||0;
                        let precio = parseFloat(d.precio)||0;
                        let stock_actual = parseFloat(d.stock_actual)||0;
                        let subtotal = cantidad*precio;
                        let proveedor = d.proveedor || '';
                        if(!proveedor) proveedor = $('#id_proveedor_global').val() || '';
                        let id_proveedor = d.id_proveedor || id_proveedor_global;

                        detalle.push({id_item:d.item_code, codigo:d.item_code, producto:d.producto,
                            proveedor, id_proveedor, stock_actual, cantidad, precio, subtotal});

                        tabla.row.add({
                            codigo:d.item_code,
                            producto:d.producto,
                            proveedor,
                            stock_actual,
                            cantidad,
                            precio:precio.toFixed(2),
                            subtotal:subtotal.toFixed(2),
                            acciones:`<button class="btn btn-sm btn-primary btn-modificar">Modificar</button>
                                     <button class="btn btn-sm btn-danger btn-eliminar">Eliminar</button>`
                        }).draw();
                    });
                    $('#id_proveedor_global').val(id_proveedor_global);
                    actualizarTotal();
                } else Swal.fire('Error',res.error||'Solicitud no encontrada','error');
            });
        }
    });

    // Filtrar productos por proveedor
    $('#cbo_proveedor_filtro').change(function(){
        let proveedor_id = $(this).val();
        $('#cbo_producto option').each(function(){
            if(!proveedor_id || $(this).data('proveedor-id')==proveedor_id){
                $(this).show();
            } else $(this).hide();
        });
        $('#cbo_producto').val('');
        $('#txt_stock_actual,#txt_precio_info').val('');
        $('#id_proveedor_global').val(proveedor_id || '');
    });

    function actualizarStockYProveedor(){
        let id_deposito = $('#cbo_deposito').val();
        let op = $('#cbo_producto option:selected');
        let id_item = op.val();
        let precio = parseFloat(op.data('precio'))||0;
        $('#txt_precio_info').val(precio.toFixed(2));

        if(id_deposito && id_item){
            $.getJSON(`/api/v1/stock/${id_deposito}/${id_item}`, function(res){
                $('#txt_stock_actual').val(res.success ? (res.stock||0) : 0);
            });
        } else $('#txt_stock_actual').val(0);

        if(id_item){
            let id_proveedor = op.data('proveedor-id')||'';
            $('#id_proveedor_global').val(id_proveedor);
        }
    }
    $('#cbo_producto,#cbo_deposito').on('change', actualizarStockYProveedor);

    $('#btn_agregar').click(function(){
        let op = $('#cbo_producto option:selected');
        let id_item = op.val();
        let producto = op.text();
        let stock_actual = parseFloat($('#txt_stock_actual').val())||0;
        let cantidad = parseFloat($('#txt_cantidad').val());
        let precio = parseFloat($('#txt_precio_info').val());
        let id_proveedor = $('#id_proveedor_global').val();
        let proveedor = op.data('proveedor-nombre') || '';

        if(!id_item || !cantidad || !precio || !id_proveedor){
            return Swal.fire("Error","Complete todos los campos","error");
        }

        let subtotal = cantidad*precio;
        detalle.push({id_item, codigo:id_item, producto, proveedor, id_proveedor, stock_actual, cantidad, precio, subtotal});

        tabla.row.add({
            codigo:id_item,
            producto,
            proveedor,
            stock_actual,
            cantidad,
            precio:precio.toFixed(2),
            subtotal:subtotal.toFixed(2),
            acciones:`<button class="btn btn-sm btn-primary btn-modificar">Modificar</button>
                     <button class="btn btn-sm btn-danger btn-eliminar">Eliminar</button>`
        }).draw();

        actualizarTotal();
        $('#cbo_producto').val('');
        $('#txt_stock_actual,#txt_cantidad,#txt_precio_info').val('');
    });

    $('#tbl_detalle tbody').on('click','.btn-modificar', function(){
        let row = $(this).closest('tr');
        let idx = tabla.row(row).index();
        let fila = detalle[idx];
        Swal.fire({
            title:'Modificar cantidad',
            input:'number',
            inputValue:fila.cantidad,
            showCancelButton:true,
            confirmButtonText:'Actualizar',
            cancelButtonText:'Cancelar',
            preConfirm:(value)=>{
                let val=parseFloat(value);
                if(isNaN(val)||val<=0) Swal.showValidationMessage('Cantidad inválida');
                return val;
            }
        }).then((result)=>{
            if(result.isConfirmed){
                fila.cantidad=result.value;
                fila.subtotal=fila.cantidad*fila.precio;
                tabla.row(row).data({
                    codigo:fila.codigo,
                    producto:fila.producto,
                    proveedor:fila.proveedor,
                    stock_actual:fila.stock_actual,
                    cantidad:fila.cantidad,
                    precio:fila.precio.toFixed(2),
                    subtotal:fila.subtotal.toFixed(2),
                    acciones:`<button class="btn btn-sm btn-primary btn-modificar">Modificar</button>
                             <button class="btn btn-sm btn-danger btn-eliminar">Eliminar</button>`
                }).draw(false);
                actualizarTotal();
            }
        });
    });

    $('#tbl_detalle tbody').on('click','.btn-eliminar', function(){
        let idx = tabla.row($(this).parents('tr')).index();
        detalle.splice(idx,1);
        tabla.row($(this).parents('tr')).remove().draw();
        actualizarTotal();
    });

    $('#btn_grabar_pedido').click(function(){
        if(detalle.length===0) return Swal.fire("Error","Debe agregar al menos un producto","error");
        let id_funcionario = $('#cbo_funcionario').val();
        let id_sucursal = $('#cbo_sucursal').val();
        let id_deposito = $('#cbo_deposito').val();
        let id_proveedor = $('#id_proveedor_global').val() || (detalle.length>0 ? detalle[0].id_proveedor : null);
        let tipo_factura = $('#cbo_tipo_factura').val();

        if(!id_funcionario||!id_sucursal||!id_deposito||!id_proveedor||!tipo_factura){
            return Swal.fire("Error","Complete todos los campos del pedido, incluyendo tipo de factura","error");
        }

        let payload={
            nro_pedido: $('#txt_nro_pedido').val(),
            id_funcionario,
            id_proveedor,
            id_sucursal,
            id_deposito,
            nro_solicitud: $('#txt_nro_solicitud').val() || null,
            fecha_pedido:$('#txt_fecha_pedido').val(),
            fecha_necesaria:$('#txt_fecha_necesaria').val()||null,
            tipo_factura,
            detalle_pedido:detalle.map(d=>({
                item_code:d.id_item,
                item_descripcion:d.producto,
                id_proveedor:d.id_proveedor,
                cant_pedido:d.cantidad,
                costo_unitario:d.precio
            }))
        };

        $.ajax({
            url:'/api/v1/gestionar-compras/registrar-pedido-compras/pedidos',
            method:'POST',
            contentType:'application/json',
            data:JSON.stringify(payload),
            success:function(res){
                if(res.success){
                    Swal.fire("Éxito","Pedido registrado","success");
                    detalle=[]; tabla.clear().draw(); actualizarTotal();
                    cargarNroPedido();
                    $('#txt_nro_solicitud').prop('readonly', true).val('');
                    $('#rb_sin_pedido').prop('checked', true);
                    $('#cbo_funcionario,#cbo_sucursal,#cbo_deposito').prop('disabled', false);
                    $('#id_proveedor_global').val('');
                    $('#cbo_tipo_factura').val('');
                } else Swal.fire("Error",res.error,"error");
            },
            error:function(){Swal.fire("Error","Ocurrió un error","error");}
        });
    });

    $('#btn_cancelar_general').click(()=> location.reload());
    $('#btn_salir_general').click(()=> window.location.href='/');
});
</script>


{% endblock %}
