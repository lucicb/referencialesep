{% extends "base.html" %}

{% block titulo %}Apertura / Cierre de Caja{% endblock %}

{% block contenido %}
<div class="container-fluid">

    <h1 class="h3 mb-4 text-gray-800">
        {{ 'Cerrar Caja' if apertura and apertura.estado=='ABIERTO' else 'Abrir Caja' }}
    </h1>

    <div class="card shadow" style="max-width:600px; margin:auto;">
        <div class="card-body">

            <form id="formAperturaCierre">

                <!-- Fila superior: Nro de Caja y Fecha Apertura -->
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Nro de Caja</label>
                        <input type="text" id="id_caja_cab" class="form-control" 
                            value="{{ apertura.id_caja_cab if apertura else proximo_id }}" readonly>
                    </div>
                    <div class="form-group col-md-6">
                        <label>Fecha Apertura</label>
                        <input type="text" id="fecha_apertura" class="form-control"
                            value="{{ apertura.fecha_apertura if apertura else fecha_hoy }}" readonly>
                    </div>
                </div>

                <!-- Sucursal y Funcionario -->
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Sucursal</label>
                        <select id="id_suc" class="form-control" required {% if apertura %}disabled{% endif %}>
                            <option value="">Seleccione...</option>
                            {% for s in sucursales %}
                                <option value="{{ s.id }}" {% if apertura and apertura.id_suc == s.id %}selected{% endif %}>
                                    {{ s.descripcion }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group col-md-6">
                        <label>Funcionario</label>
                        <select id="usu_id" class="form-control" required {% if apertura %}disabled{% endif %}>
                            <option value="">Seleccione...</option>
                            {% for f in funcionarios %}
                                <option value="{{ f.usu_id }}" {% if apertura and apertura.usu_id == f.usu_id %}selected{% endif %}>
                                    {{ f.usu_nick }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Monto Inicial / Final -->
                <div class="form-group">
                    <label>{{ 'Monto Final' if apertura and apertura.estado=='ABIERTO' else 'Monto Inicial' }}</label>
                    <input type="number" id="monto" class="form-control" step="1" min="0"
                        value="{{ apertura.monto_final if apertura and apertura.estado=='ABIERTO' else '' }}" 
                        {% if apertura and apertura.estado=='CERRADO' %}readonly{% endif %} required>
                </div>

                <!-- Botón de acción -->
                <div class="text-right">
                    <button type="button" class="btn btn-primary btn-block" id="btnAccion">
                        {{ 'Cerrar Caja' if apertura and apertura.estado=='ABIERTO' else 'Abrir Caja' }}
                    </button>
                </div>

            </form>

        </div>
    </div>

</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$('#btnAccion').click(function() {
    let id_caja_cab = $('#id_caja_cab').val();
    let id_suc = $('#id_suc').val();
    let usu_id = $('#usu_id').val();
    let monto = parseFloat($('#monto').val());

    if(!id_suc || !usu_id || !monto){
        Swal.fire('Error', 'Todos los campos son obligatorios', 'error');
        return;
    }

    let payload = {
        id_suc: id_suc,
        usu_id: usu_id,
        monto: monto
    };

    {% if apertura and apertura.estado=='ABIERTO' %}
        // CERRAR CAJA
        $.ajax({
            url: '/api/v1/apertura-cierre/cerrar/{{ apertura.id_caja_cab }}',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(response) {
                if(response.success) {
                    Swal.fire('Éxito', 'Caja cerrada correctamente', 'success').then(() => {
                        window.location.href = '/ventas/apertura-cierre';
                    });
                } else {
                    Swal.fire('Error', response.error, 'error');
                }
            },
            error: function(xhr){
                console.error('Error:', xhr.responseText);
                Swal.fire('Error', 'Ocurrió un error al cerrar la caja', 'error');
            }
        });
    {% else %}
        // ABRIR CAJA
        $.ajax({
            url: '/api/v1/apertura-cierre',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(response) {
                if(response.success) {
                    Swal.fire('Éxito', 'Caja abierta correctamente', 'success').then(() => {
                        window.location.href = '/ventas/apertura-cierre';
                    });
                } else {
                    Swal.fire('Error', response.error, 'error');
                }
            },
            error: function(xhr){
                console.error('Error:', xhr.responseText);
                Swal.fire('Error', 'Ocurrió un error al abrir la caja', 'error');
            }
        });
    {% endif %}
});
</script>
{% endblock %}