{% extends "base.html" %}

{% block titulo %}Pedidos de Clientes{% endblock %}

{% block contenido %}
<div class="container-fluid">

    <h1 class="h3 mb-4 text-gray-800">
        {{ 'Editar Pedido' if pedido else 'Nuevo Pedido de Cliente' }}
    </h1>

    <div class="card shadow">
        <div class="card-body">

            <form id="formPedidoCliente">
                <input type="hidden" id="id_pedido_cab"
                       value="{{ pedido.id_pedido_cab if pedido else '' }}">

                <div class="row">

                    <!-- Cliente -->
                    <div class="col-md-4">
                        <label>Cliente</label>
                        <select id="id_cliente" class="form-control select2" required>
                            <option value="">Seleccione...</option>
                            {% for c in clientes %}
                                <option value="{{ c.id_cliente }}"
                                    {% if pedido and pedido.id_cliente == c.id_cliente %}selected{% endif %}>
                                    {{ c.ci }} - {{ c.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Sucursal -->
                    <div class="col-md-4">
                        <label>Sucursal</label>
                        <select id="id_suc" class="form-control" required>
                            <option value="">Seleccione...</option>
                            {% for s in sucursales %}
                                <option value="{{ s.id }}"
                                    {% if pedido and pedido.id_suc == s.id %}selected{% endif %}>
                                    {{ s.descripcion }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Funcionario -->
                    <div class="col-md-4">
                        <label>Funcionario</label>
                        <select id="usu_id" class="form-control" required>
                            <option value="">Seleccione...</option>
                            {% for u in funcionarios %}
                                <option value="{{ u.usu_id }}"
                                    {% if pedido and pedido.usu_id == u.usu_id %}selected{% endif %}>
                                    {{ u.usu_nick }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                </div>

                <br>

                <div class="row">
                    <div class="col-md-4">
                        <label>Fecha Pedido</label>
                        <input type="date" id="fecha_pedido"
                               class="form-control"
                               value="{{ pedido.fecha_pedido if pedido else fecha_hoy }}"
                               required>
                    </div>

                    <div class="col-md-4">
                        <label>Fecha Entrega</label>
                        <input type="date" id="fecha_entrega"
                               class="form-control"
                               value="{{ pedido.fecha_entrega if pedido else '' }}"
                               required>
                    </div>

                    <div class="col-md-4">
                        <label>Observaciones</label>
                        <input type="text" id="observaciones"
                               class="form-control"
                               value="{{ pedido.observaciones if pedido else '' }}">
                    </div>
                </div>

                <hr>

                <h5>Productos del Pedido</h5>

                <button type="button" class="btn btn-success btn-sm mb-2" onclick="agregarFila()">+ Agregar Producto</button>

                <table class="table table-bordered" id="tblDetalle">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Observación</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>

                        {% if pedido and pedido.detalle %}
                            {% for d in pedido.detalle %}
                            <tr>
                                <td>
                                    <select class="form-control id_producto_det" required>
                                        {% for p in productos %}
                                            <option value="{{ p.id_producto }}"
                                                {% if d.id_producto == p.id_producto %}selected{% endif %}>
                                                {{ p.nombre }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>

                                <td><input type="number" class="form-control cantidad" step="1" min="0"
                                           value="{{ d.cantidad }}" required></td>

                                <td><input type="number" class="form-control precio" step="1" min="0"
                                           value="{{ d.precio_unitario }}" required></td>

                                <td><input type="text" class="form-control obs_det"
                                           value="{{ d.observaciones }}"></td>

                                <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">X</button></td>
                            </tr>
                            {% endfor %}
                        {% endif %}

                    </tbody>
                </table>

                <hr>

                <button type="button" onclick="guardar()" class="btn btn-primary">Guardar Pedido</button>

            </form>

        </div>
    </div>

</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {
    $('.select2').select2({
        placeholder: "Seleccione un cliente",
        allowClear: true
    });
});

let productosData = JSON.parse('{{ productos|tojson|safe }}');

function agregarFila() {
    let options = productosData.map(p => `<option value="${p.id_producto}">${p.nombre}</option>`).join('');
    let fila = `
        <tr>
            <td><select class="form-control id_producto_det">${options}</select></td>
            <td><input type="number" class="form-control cantidad" step="1" min="0"></td>
            <td><input type="number" class="form-control precio" step="1" min="0"></td>
            <td><input type="text" class="form-control obs_det"></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">X</button></td>
        </tr>
    `;
    $('#tblDetalle tbody').append(fila);
}

function eliminarFila(btn) {
    $(btn).closest('tr').remove();
}

async function obtenerCsrfToken() {
    let res = await fetch('/api/v1/pedidos-clientes/csrf-token');
    let data = await res.json();
    return data.csrf_token;
}

async function guardar() {
    console.log('Guardando pedido...');

    // Validar campos principales
    let id_cliente = $('#id_cliente').val();
    let id_suc = $('#id_suc').val();
    let usu_id = $('#usu_id').val();
    let fecha_pedido = $('#fecha_pedido').val();
    let fecha_entrega = $('#fecha_entrega').val();

    if(!id_cliente || !id_suc || !usu_id || !fecha_pedido || !fecha_entrega) {
        Swal.fire('Error', 'Complete todos los campos obligatorios', 'error');
        return;
    }

    // Construir detalle
    let detalle = [];
    $('#tblDetalle tbody tr').each(function() {
        let id_producto = $(this).find('.id_producto_det').val();
        let cantidad = parseFloat($(this).find('.cantidad').val());
        let precio = parseFloat($(this).find('.precio').val());
        let obs = $(this).find('.obs_det').val();

        if(id_producto && !isNaN(cantidad) && cantidad > 0 && !isNaN(precio) && precio > 0) {
            detalle.push({
                id_producto: id_producto,
                cantidad: cantidad,
                precio_unitario: precio,
                observaciones: obs || ''
            });
        }
    });

    if(detalle.length === 0){
        Swal.fire('Error', 'Debe agregar al menos un producto con cantidad y precio válidos', 'error');
        return;
    }

    let payload = {
        id_cliente: parseInt(id_cliente),
        id_suc: parseInt(id_suc),
        usu_id: usu_id,
        fecha_pedido: fecha_pedido,
        fecha_entrega: fecha_entrega,
        estado: 'PENDIENTE',
        observaciones: $('#observaciones').val() || '',
        detalle: detalle
    };

    console.log('Payload:', payload);

    try {
        let csrf_token = await obtenerCsrfToken();

        $.ajax({
            url: '/api/v1/pedidos-clientes',
            type: 'POST',
            headers: { 'X-CSRFToken': csrf_token },
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(response) {
                console.log('Respuesta:', response);
                if(response.success !== false) {
                    Swal.fire('Éxito', 'Pedido guardado correctamente', 'success').then(() => {
                        window.location.href = '/ventas/pedidos-clientes';
                    });
                } else {
                    Swal.fire('Error', response.error || 'Error al guardar', 'error');
                }
            },
            error: function(xhr) {
                console.error('Error:', xhr.responseText);
                let errorMsg = 'Error al guardar el pedido';
                try {
                    let resp = JSON.parse(xhr.responseText);
                    errorMsg = resp.error || errorMsg;
                } catch(e) {}
                Swal.fire('Error', errorMsg, 'error');
            }
        });
    } catch(e) {
        console.error('Error obteniendo token:', e);
        Swal.fire('Error', 'Error al procesar la solicitud', 'error');
    }
}  // <-- Cierre correcto de la función guardar()
</script>
{% endblock %}
