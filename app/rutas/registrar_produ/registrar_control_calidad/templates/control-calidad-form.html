{% extends "base.html" %}

{% block titulo %}Control de Calidad{% endblock %}

{% block contenido %}
<div class="container-fluid">

    <h1 class="h3 mb-4 text-gray-800">
        {{ 'Editar Control de Calidad' if cabecera else 'Nuevo Control de Calidad' }}
    </h1>

    <div class="card shadow">
        <div class="card-body">

            <!-- FORMULARIO -->
            <form id="formControlCalidad">

                <input type="hidden" id="id_cali_cab"
                       value="{{ cabecera.id_cali_cab if cabecera else '' }}">

                <!-- =====================
                     CABECERA
                ====================== -->
                <div class="row">

                    <!-- Orden Producción -->
                    <div class="col-md-4">
                        <label>Orden de Producción</label>
                        <select id="cod_orden_prod_cab" class="form-control" required>
                            <option value="">Seleccione...</option>
                            {% for o in ordenes %}
                                <option value="{{ o.cod_orden_prod_cab }}"
                                    {% if cabecera and cabecera.cod_orden_prod_cab == o.cod_orden_prod_cab %}selected{% endif %}>
                                    {{ o.cod_orden_prod_cab }} - {{ o.producto }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Fecha del control -->
                    <div class="col-md-4">
                        <label>Fecha Control</label>
                        <input type="datetime-local" id="fecha_control"
                               class="form-control"
                               value="{{ cabecera.fecha_control if cabecera else '' }}"
                               required>
                    </div>

                    <!-- Responsable -->
                    <div class="col-md-4">
                        <label>Responsable</label>
                        <select id="usu_id" class="form-control" required>
                            <option value="">Seleccione...</option>
                            {% for f in funcionarios %}
                                <option value="{{ f.usu_id }}"
                                    {% if cabecera and cabecera.usu_id == f.usu_id %}selected{% endif %}>
                                    {{ f.usu_nick }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                </div>

                <br>

                <div class="row">

                    <!-- Resultado -->
                    <div class="col-md-4">
                        <label>Resultado</label>
                        <select id="resultado" class="form-control" required>
                            <option value="">Seleccione...</option>
                            <option value="APROBADO"
                                {% if cabecera and cabecera.resultado == 'APROBADO' %}selected{% endif %}>
                                Aprobado
                            </option>
                            <option value="RECHAZADO"
                                {% if cabecera and cabecera.resultado == 'RECHAZADO' %}selected{% endif %}>
                                Rechazado
                            </option>
                            <option value="OBSERVADO"
                                {% if cabecera and cabecera.resultado == 'OBSERVADO' %}selected{% endif %}>
                                Observado
                            </option>
                        </select>
                    </div>

                    <!-- Estado -->
                    <div class="col-md-4">
                        <label>Estado</label>
                        <select id="estado" class="form-control" required>
                            <option value="">Seleccione...</option>
                            <option value="ACTIVO"
                                {% if cabecera and cabecera.estado == 'ACTIVO' %}selected{% endif %}>Activo</option>
                            <option value="INACTIVO"
                                {% if cabecera and cabecera.estado == 'INACTIVO' %}selected{% endif %}>Inactivo</option>
                        </select>
                    </div>

                    <!-- Observaciones -->
                    <div class="col-md-4">
                        <label>Observaciones</label>
                        <input type="text" id="observaciones" class="form-control"
                               value="{{ cabecera.observaciones if cabecera else '' }}">
                    </div>

                </div>

                <hr>

                <!-- =====================
                     DETALLE
                ====================== -->
                <h5>Detalle del Control</h5>
                <button type="button" class="btn btn-success btn-sm mb-2" onclick="agregarFila()">
                    + Agregar Ítem
                </button>

                <table class="table table-bordered" id="tblDetalle">
                    <thead class="thead-light">
                        <tr>
                            <th>Valor Esperado</th>
                            <th>Valor Obtenido</th>
                            <th>Resultado</th>
                            <th>Observaciones</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>

                        {% if cabecera and cabecera.detalle %}
                            {% for d in cabecera.detalle %}
                            <tr>
                                <td><input class="form-control valor_esperado" value="{{ d.valor_esperado }}" required></td>
                                <td><input class="form-control valor_obtenido" value="{{ d.valor_obtenido }}" required></td>
                                <td>
                                    <select class="form-control resultado_det">
                                        <option value="APROBADO" {% if d.resultado == 'APROBADO' %}selected{% endif %}>Aprobado</option>
                                        <option value="RECHAZADO" {% if d.resultado == 'RECHAZADO' %}selected{% endif %}>Rechazado</option>
                                        <option value="OBSERVADO" {% if d.resultado == 'OBSERVADO' %}selected{% endif %}>Observado</option>
                                    </select>
                                </td>
                                <td><input class="form-control observaciones_det" value="{{ d.observaciones }}"></td>
                                <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">X</button></td>
                            </tr>
                            {% endfor %}
                        {% endif %}

                    </tbody>
                </table>

                <hr>

                <button type="button" onclick="guardar()" class="btn btn-primary">
                    Guardar Control
                </button>

            </form>

        </div>
    </div>

</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

function agregarFila() {
    let fila = `
        <tr>
            <td><input class="form-control valor_esperado" required></td>
            <td><input class="form-control valor_obtenido" required></td>
            <td>
                <select class="form-control resultado_det">
                    <option value="APROBADO">Aprobado</option>
                    <option value="RECHAZADO">Rechazado</option>
                    <option value="OBSERVADO">Observado</option>
                </select>
            </td>
            <td><input class="form-control observaciones_det"></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">X</button></td>
        </tr>
    `;
    $('#tblDetalle tbody').append(fila);
}

function eliminarFila(btn) {
    $(btn).closest('tr').remove();
}

async function guardar() {

    let detalle = [];
    $('#tblDetalle tbody tr').each(function() {
        detalle.push({
            valor_esperado: $(this).find('.valor_esperado').val(),
            valor_obtenido: $(this).find('.valor_obtenido').val(),
            resultado: $(this).find('.resultado_det').val(),
            observaciones: $(this).find('.observaciones_det').val(),
        });
    });

    if(detalle.length === 0){
        Swal.fire('Error', "Debe agregar al menos un ítem de control", 'error');
        return;
    }

    let payload = {
        id_cali_cab: $('#id_cali_cab').val(),
        cod_orden_prod_cab: $('#cod_orden_prod_cab').val(),
        fecha_control: $('#fecha_control').val(),
        responsable: $('#usu_id').val(),
        resultado: $('#resultado').val(),
        observaciones: $('#observaciones').val(),
        estado: $('#estado').val(),
        detalle: detalle
    };

    $.ajax({
        url: "/api/v1/control-calidad",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(payload),
        success: function() {
            Swal.fire('Éxito', 'Control de Calidad guardado correctamente', 'success')
        },
        error: function(err) {
            console.log(err);
            Swal.fire('Error', 'Ocurrió un error al guardar', 'error');
        }
    });
}

</script>
{% endblock %}
