{% extends "base.html" %}

{% block titulo %}Orden de Producción{% endblock %}

{% block contenido %}
<div class="container-fluid">

    <h1 class="h3 mb-4 text-gray-800">
        {{ 'Editar Orden' if orden else 'Nueva Orden de Producción' }}
    </h1>

    <div class="card shadow">
        <div class="card-body">

            <form id="formOrdenProduccion">
                <input type="hidden" id="cod_orden_prod_cab"
                       value="{{ orden.cod_orden_prod_cab if orden else '' }}">

                <div class="row">
                    <!-- Producto -->
                    <div class="col-md-4">
                        <label>Producto a producir</label>
                        <select id="id_producto" class="form-control" required>
                            <option value="">Seleccione...</option>
                            {% for p in productos %}
                                <option value="{{ p.id_producto }}"
                                    {% if orden and orden.id_producto == p.id_producto %}selected{% endif %}>
                                    {{ p.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Sucursal -->
                    <div class="col-md-4">
                        <label>Sucursal</label>
                        <select id="id_suc" class="form-control" required>
                            <option value="">Seleccione...</option>
                            {% for s in sucursales %}
                                <option value="{{ s.id }}"
                                    {% if orden and orden.id_suc == s.id %}selected{% endif %}>
                                    {{ s.descripcion }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Funcionario -->
                    <div class="col-md-4">
                        <label>Funcionario</label>
                        <select id="usu_id" class="form-control" required>
                            <option value="">Seleccione...</option>
                            {% for f in funcionarios %}
                                <option value="{{ f.usu_id }}"
                                    {% if orden and orden.usu_id == f.usu_id %}selected{% endif %}>
                                    {{ f.usu_nick }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <br>

                <div class="row">
                    <!-- Fecha Inicio -->
                    <div class="col-md-4">
                        <label>Fecha Inicio</label>
                        <input type="date" id="fecha_inicio"
                               class="form-control"
                               value="{{ orden.fecha_inicio if orden else '' }}"
                               required>
                    </div>

                    <!-- Fecha Fin Estimada -->
                    <div class="col-md-4">
                        <label>Fecha Fin Estimada</label>
                        <input type="date" id="fecha_fin_estimada"
                               class="form-control"
                               value="{{ orden.fecha_fin_estimada if orden else '' }}"
                               required>
                    </div>
                </div>

                <hr>

                <h5>Materiales / Componentes</h5>
                <button type="button" class="btn btn-success btn-sm mb-2" onclick="agregarFila()">+ Agregar Material</button>

                <table class="table table-bordered" id="tblDetalle">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Costo Unitario</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if orden and orden.detalle %}
                            {% for d in orden.detalle %}
                            <tr>
                                <td>
                                    <select class="form-control id_producto_det" required>
                                        {% for p in productos %}
                                            <option value="{{ p.id_producto }}"
                                                {% if d.id_producto == p.id_producto %}selected{% endif %}>
                                                {{ p.nombre }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td><input type="number" class="form-control cantidad" step="0.01" min="0" value="{{ d.cantidad }}" required></td>
                                <td><input type="number" class="form-control costo" step="0.01" min="0" value="{{ d.costo_unitario }}" required></td>
                                <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">X</button></td>
                            </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>

                <hr>
                <button type="button" onclick="guardar()" class="btn btn-primary">Guardar Orden</button>
            </form>

        </div>
    </div>

</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// ====================
// Variables JS
// ====================
let productosData = JSON.parse('{{ productos|tojson|safe }}');
let sucursalesData = JSON.parse('{{ sucursales|tojson|safe }}');
let funcionariosData = JSON.parse('{{ funcionarios|tojson|safe }}');

function agregarFila() {
    let options = productosData.map(p => `<option value="${p.id_producto}">${p.nombre}</option>`).join('');
    let fila = `
        <tr>
            <td>
                <select class="form-control id_producto_det" required>
                    ${options}
                </select>
            </td>
            <td><input type="number" class="form-control cantidad" step="0.01" min="0" required></td>
            <td><input type="number" class="form-control costo" step="0.01" min="0" required></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">X</button></td>
        </tr>
    `;
    $('#tblDetalle tbody').append(fila);
}

function eliminarFila(btn) {
    $(btn).closest('tr').remove();
}

async function obtenerCsrfToken() {
    try {
        let res = await fetch('/api/v1/orden-produccion/csrf-token');
        let data = await res.json();
        return data.csrf_token;
    } catch (err) {
        console.error("Error obteniendo CSRF token:", err);
        return null;
    }
}

async function guardar() {
    let detalle = [];
    $('#tblDetalle tbody tr').each(function() {
        let id_producto = $(this).find('.id_producto_det').val();
        let cantidad = parseFloat($(this).find('.cantidad').val());
        let costo = parseFloat($(this).find('.costo').val());
        if(id_producto && !isNaN(cantidad) && !isNaN(costo)) {
            detalle.push({id_producto: parseInt(id_producto), cantidad, costo_unitario: costo});
        }
    });

    if(detalle.length === 0){
        Swal.fire('Error', "Debe agregar al menos un material válido", 'error');
        return;
    }

    let id_producto = parseInt($('#id_producto').val());
    let id_suc = parseInt($('#id_suc').val());
    let usu_id = parseInt($('#usu_id').val());
    let fecha_inicio = $('#fecha_inicio').val();
    let fecha_fin_estimada = $('#fecha_fin_estimada').val();

    if (!id_producto || !id_suc || !usu_id || !fecha_inicio || !fecha_fin_estimada) {
        Swal.fire('Error', "Todos los campos de la cabecera son obligatorios", 'error');
        return;
    }

    let payload = {id_producto, id_suc, usu_id, fecha_inicio, fecha_fin_estimada, detalle};
    let csrf_token = await obtenerCsrfToken();
    if (!csrf_token) {
        Swal.fire('Error', "No se pudo obtener CSRF token", 'error');
        return;
    }

    $.ajax({
        url: "/api/v1/orden-produccion",
        type: "POST",
        contentType: "application/json",
        headers: { "X-CSRFToken": csrf_token },
        data: JSON.stringify(payload),
        success: function() {
            Swal.fire('Éxito', 'Orden guardada correctamente', 'success').then(() => {
                // Limpiar campos
                $('#formOrdenProduccion')[0].reset();
                $('#tblDetalle tbody').empty();
            });
        },
        error: function(err) {
            Swal.fire('Error', "Error al guardar. Revisa la consola", 'error');
            console.log(err.responseJSON || err);
        }
    });
}
</script>
{% endblock %}
